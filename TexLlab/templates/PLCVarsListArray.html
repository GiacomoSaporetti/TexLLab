<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
	<title>Variables List</title>
	<script type="text/javascript">
		/* ---------------- FINESTRA DI SELEZIONE ELEMENTI DI ARRAY --------------------------

		INPUT VarsList_input : [ { name: string, type: string, size: int, description: string } ]
		OUTPUT VarsList_result : { idx: int, fromElem: int, toElem: int }

		*/

		try
		{ csspath = "file://" + window.external.CatalogPath + "../Common/CSS/" }  // chiede il csspath all'applicazione host
		catch (e)
		{ csspath = document.cookie.slice(8) }  // ricava il csspath dal cookie chiamato 'csspath'

		document.write("<LINK href='" + csspath + "style.css' rel='stylesheet' type='text/css'>")
		// deprecato: ora lo stile di varslist e' incluso nel CSS generico
		// document.write("<LINK href='" + csspath + "varslist.css' rel='stylesheet' type='text/css'>")
		document.write("<SCRIPT src='" + csspath + "../script/common.js' type='text/javascript'></" + "SCRIPT>")
		document.write("<SCRIPT src='" + csspath + "../script/PLCVars.js' type='text/javascript'></" + "SCRIPT>")

		var m_curFilter
		var m_inputList

		function Init()
		{
			// reset var risultato
			m_inputList = app.TempVar("VarsList_input")
			app.TempVar("VarsList_input")  = undefined
			app.TempVar("VarsList_result") = undefined

			FillList()
		}

		function FillList(forceRefresh)
		{
			if (filter.value.toLowerCase() == m_curFilter && !forceRefresh)
				// tasto che non ha modificato il filtro (es frecce)
				return
			
			m_curFilter = filter.value.toLowerCase()
			
			// svuotamento lista
			list.options.length = 0;
			
			for (var i = 0; i < m_inputList.length; i++)
			{
				var item = m_inputList[i]
				
				var s = item.name + "   ( 0.." + (item.size-1) + " OF " + item.type + " )"
				
				if (item.description)
					s += " - " + item.description
				
				if (m_curFilter == "" || s.toLowerCase().indexOf(m_curFilter) != -1)
				{
					// aggiunge se nessun filtro o filtro ok
					var option = document.createElement("option");
					option.text = s;
					option.value = i;
					list.add(option);
				}
			}
		}

		function CloseOK()
		{
			if (list.selectedIndex == -1)
				return

			var option = list.options[list.selectedIndex];

			var result = {
				idx: option.value, 
				fromElem: parseInt(txtFrom.value), 
				toElem: parseInt(txtTo.value)
			}
			
			if (isNaN(result.fromElem) || result.fromElem < 0)
			{
				alert(app.Translate("Invalid 'From' field"))
				return
			}
			
			if (isNaN(result.toElem) || result.toElem > m_inputList[result.idx].size - 1 || result.toElem < result.fromElem)
			{
				alert(app.Translate("Invalid 'To' field"))
				return
			}
			
			window.external.TempVar("VarsList_result") = result
			CloseDlg()
		}

		function OnListDblClick()
		{
			if (list.selectedIndex != -1)
				// doppio click sulla lista seleziona e conferma
				CloseOK();
		}

		function OnListClick()
		{
			if (list.selectedIndex != -1)
			{
				var option = list.options[list.selectedIndex];
				var idx = option.value;
				txtFrom.value = 0
				txtTo.value = m_inputList[idx].size - 1
			}
		}
	</script>
</head>

<body class="varslist" onload="Init()">
	<input type="hidden" name=".DATAPATH" id="datapath">

	<div class="container">
		<div>
			<label for="filter"><t:t>Filter</t:t>: </label><input style="width: 330px" type="text" id="filter" onkeyup="FillList()">
		</div>

		<div class="list-container mt-xs">
			<!-- size=2 e' un workaround per mostrare la lista di option e non la select "singola" -->
			<select id="list" ondblclick="OnListDblClick()" onclick="OnListClick()" size="2"></select>
		</div>

		<div class="mt-xs">
			<label for="txtFrom"><t:t>From</t:t>: </label> <input id="txtFrom" type="text" size="5" maxlength="5">&nbsp;&nbsp;&nbsp;
			<label for="txtTo"><t:t>To</t:t>: </label> <input id="txtTo" type="text" size="5" maxlength="5">
		</div>

		<div class="btn-container">
			<button class="FlatButton" onclick="CloseOK()"><t:t>OK</t:t></button>
			<button class="FlatButton" onclick="CloseDlg()"><t:t>Cancel</t:t></button>
		</div>
	</div>
</body>
</html>