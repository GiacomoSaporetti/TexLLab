<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Mesage Alerts</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
	
	<script type="text/javascript" src="grid_MachineParameters.js"></script>
	
	<script type="text/javascript">
	try
	{ csspath = "file://" + window.external.CatalogPath + "../Common/CSS/" }  // chiede il csspath all'applicazione host
	catch (e)
	{ csspath = document.cookie.slice(8) }  // ricava il csspath dal cookie chiamato 'csspath'

	document.write("<LINK href='" + csspath + "style.css' rel='stylesheet' type='text/css'></link>")
	document.write("<SCRIPT src='" + csspath + "../script/common.js' type='text/javascript'></" + "SCRIPT>")
	document.write("<SCRIPT src='" + csspath + "../script/Polyfills.js' type='text/javascript'></" + "SCRIPT>")

	var app = window.external
	var genfuncs = app.CallFunction("common.GetGeneralFunctions");

	var m_darkTheme = false;
	try
	{
		m_darkTheme = app.IsDarkTheme();
	}
	catch(err){}

	var m_parTipoAzionamentoAvailable = false;
	var m_axisInstalled = true;

	var m_itemMap;
	// dal numero di riga torna l'ID del parametro
	var m_itemPositionList;

	const PAR_TIPO_AZIONAMENTO = 60;
	const PAR_TIPO_AZIONAMENTO_QRY = "messageAlerts[uniqueID='" + PAR_TIPO_AZIONAMENTO + "']/value";

	const ECAT_PAR_REGEX = /^ECAT.+$/;
	const CAN_PAR_REGEX = /^CANOpen.+$/;
	const DELTA_INVERTER_PAR_IDs = [22,23,31];
	const INV_OFFS_ENCODER_MOTOR_IDs = [62,63,76];
	const SPECIAL_PARS_IDs = [78,28,75,14,62];
	const SPECIAL_PARS_ECAT_IDs = [108,28,75,14,62];

	const ECAT_VAL = 11;
	const CAN_VAL = 9;
	const FIRST_18_VAL = 9;
	const INVERTER_VALs = [4,5,6];

	// matrice con {pageNumber:[lista di uniqueID]}
	// so possono fare assunzioni solo sulla pagina 0; gli altri assi non e' garantito che rimangano nella stessa posizione
	const READ_ONLY_PARS = {0:[0,4]};

	function InitPage()
	{
		pageTitle.innerText = app.DataGet(_DATAPATH + "@caption", 0)

		SearchError(_DATAPATH)

		FixStyleForGrids();

		m_axisInstalled = genfuncs.ParseBoolean(app.DataGet(_DATAPATH + "@enabled", 0));
		UpdateParAzionamento();

		UpdateGridPars();
	}
	
	function UpdateGridPars() {
		m_itemMap = {};
		m_itemPositionList = [];

		// valore del parametro dell'azionamento (che significa che siamo posizionati su un menu SPECIALE)
		if (m_parTipoAzionamentoAvailable)
			var parTipoAzionamentoVal = parseInt(app.DataGet(_DATAPATH + PAR_TIPO_AZIONAMENTO_QRY, 0));
		// i parametri OPERATORE senza asse installato sono vuoti
		else if (!m_axisInstalled)
			return;

		let curNode = -1;

		let itemNodes = app.SelectNodesXML(_DATAPATH + "./*");
		let itemNode;
		while (itemNode = itemNodes.nextNode()) {
			curNode++;

			let uniqueID = parseInt(genfuncs.GetNodeText(itemNode, "uniqueID"));
			let descr = genfuncs.GetNodeText(itemNode, "descr");

			if (m_axisInstalled) {
				if (m_parTipoAzionamentoAvailable) {
					// i parametri ECAT vengono mostrati solo con valore dell'asse = 11
					if (parTipoAzionamentoVal != ECAT_VAL && ECAT_PAR_REGEX.test(descr))
						continue;

					// i parametri CAN vengono mostrati solo con valore dell'asse = 9
					if (parTipoAzionamentoVal != CAN_VAL && CAN_PAR_REGEX.test(descr))
						continue;

					// i primi 18 parametri vengono mostrati solo con valore < 9
					if (curNode <= 18 && parTipoAzionamentoVal >= FIRST_18_VAL)
						continue;

					if (DELTA_INVERTER_PAR_IDs.includes(uniqueID) && !INVERTER_VALs.includes(parTipoAzionamentoVal))
						continue;

					// per non creare confusione
					if (uniqueID == PAR_TIPO_AZIONAMENTO)
						continue;
				}
			}
			else {
				if (parTipoAzionamentoVal != ECAT_VAL && !SPECIAL_PARS_IDs.includes(uniqueID))
					continue;
			
				if (parTipoAzionamentoVal == ECAT_VAL && !SPECIAL_PARS_ECAT_IDs.includes(uniqueID))
					continue;
			}

			let nodeObj = {}
			// estrae tutti gli attributi che trova
			let nodes = itemNode.childNodes;
			for (var i = 0; i < nodes.length; i++) {
				var node = nodes[i];

				if (node.nodeType === 1) { // Element node
					var nodeName = node.nodeName;
					var textContent = node.text;

					nodeObj[nodeName] = textContent;
				}
			}

			m_itemMap[uniqueID] = nodeObj;
			m_itemPositionList.push(uniqueID);
		}
	}

	function UpdateParAzionamento() {
		var nodes = app.SelectNodesXML(_DATAPATH + PAR_TIPO_AZIONAMENTO_QRY);
		if (nodes && nodes.length > 0) {
			idx60ParTxt.value = nodes[0].text;
			m_parTipoAzionamentoAvailable = true;
		}
		else
			idx60ParContainer.style.visibility = "hidden";
	}

	function OnParAzionamentoKeyDown(e) {
		var KEY_ENTER = 13
		if (e.keyCode == KEY_ENTER) {
			app.DataSet(_DATAPATH + PAR_TIPO_AZIONAMENTO_QRY, 0, e.target.value);
			e.target.blur();

			grid.DeleteRows(m_itemPositionList.length);
			UpdateGridPars();
			grid.InsertRows(m_itemPositionList.length);
		}
	}
	</script>

	<style>
		#idx60ParContainer {
			position: absolute;
			top: 10px;
			left: 20px;
		}

		#idx60ParTxt {
			width: 50px;
		}
	</style>
</head>

<body onload="InitGridAlert(datapath.value)" class="html5">

<input type="hidden" name=".DATAPATH" id="datapath">

<div class="fill-height-container">
	<div class="TitlePag">
		<span id="pageTitle">Message Alerts</span>
	</div>
	<span id="idx60ParContainer">
		<label for="" style="color: white;"><t:t>Drive type (par 60)</t:t>: </label>
		<input type="number" id="idx60ParTxt" onkeydown="OnParAzionamentoKeyDown(event)" onblur="UpdateParAzionamento()">
	</span>

	<div class="fill-height">
		<object id="grid" classid="clsid:7E61CABD-EB07-425A-9315-B6B2D454BAC1" width="100%" height="100%" border="0">
			<param name="margin" value="40">
			<param name="multiselect" value="1">
		</object>
	</div>
</div>

<script type="text/javascript" src="grid_MachineParameters_events.js"></script>

<script>
	// la funzione verrï¿½ eseguita PRIMA della visualizzazione della pagina
	InitPage()
</script>

</body>
</html>
